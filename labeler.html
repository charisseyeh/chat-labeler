<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversation Labeler</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f7f7f8;
        }
        
        .header {
            background: white;
            border-bottom: 1px solid #e5e5e5;
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            margin: 0;
            font-size: 20px;
            color: #374151;
        }
        
        .stats {
            font-size: 14px;
            color: #6b7280;
            margin-top: 5px;
        }
        
        .conversation-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .conversation {
            background: white;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .conversation-header {
            background: #f9fafb;
            padding: 15px 20px;
            border-bottom: 1px solid #e5e5e5;
        }
        
        .conversation-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
        }
        
        .ai-classification {
            font-size: 12px;
            color: #6b7280;
        }
        
        .messages {
            padding: 20px;
        }
        
        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
        }
        
        .message.user {
            flex-direction: row-reverse;
        }
        
        .message.assistant {
            flex-direction: row;
        }
        
        .avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }
        
        .avatar.user {
            background: #10a37f;
            color: white;
        }
        
        .avatar.assistant {
            background: #f7f7f8;
            color: #374151;
        }
        
        .message-content {
            flex: 1;
            max-width: 70%;
        }
        
        .message.user .message-content {
            background: #10a37f;
            color: white;
            padding: 12px 16px;
            border-radius: 18px 18px 4px 18px;
        }
        
        .message.assistant .message-content {
            background: #f7f7f8;
            color: #374151;
            padding: 12px 16px;
            border-radius: 18px 18px 18px 4px;
        }
        
        /* Markdown styling */
        .message-content h1, .message-content h2, .message-content h3, 
        .message-content h4, .message-content h5, .message-content h6 {
            margin: 8px 0 4px 0;
            font-weight: 600;
        }
        
        .message-content p {
            margin: 4px 0;
            line-height: 1.5;
        }
        
        .message-content ul, .message-content ol {
            margin: 4px 0;
            padding-left: 20px;
        }
        
        .message-content li {
            margin: 2px 0;
        }
        
        .message-content code {
            background: rgba(0,0,0,0.1);
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }
        
        .message-content pre {
            background: rgba(0,0,0,0.1);
            padding: 8px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 4px 0;
        }
        
        .message-content blockquote {
            border-left: 3px solid #ddd;
            margin: 4px 0;
            padding-left: 12px;
            color: #666;
        }
        
        .message-labels {
            margin-top: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        
        .message-labels .label-inputs {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: flex-start;
        }
        
        .message-labels .label-input {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
        }
        
        .message-labels .label-input input[type="text"] {
            padding: 4px 6px;
            border: 1px solid #d1d5db;
            border-radius: 3px;
            font-size: 11px;
            width: 120px;
        }
        
        .message-labels .label-input input[type="checkbox"] {
            margin: 0;
        }
        
        .message-labels .label-input label {
            font-size: 11px;
            color: #374151;
            white-space: nowrap;
        }
        
        .labeling-section {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .labeling-section h3 {
            margin: 0 0 10px 0;
            color: #0c4a6e;
            font-size: 14px;
        }
        
        .label-inputs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .label-input {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .label-input input[type="text"] {
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
            width: 120px;
        }
        
        .label-input input[type="checkbox"] {
            margin: 0;
        }
        
        .label-input label {
            font-size: 12px;
            color: #374151;
        }
        
        .navigation {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        
        .nav-button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .nav-button.primary {
            background: #10a37f;
            color: white;
        }
        
        .nav-button.secondary {
            background: #6b7280;
            color: white;
        }
        
        .export-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .export-button {
            background: #059669;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .export-button:hover {
            background: #047857;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Conversation Labeler</h1>
        <div class="stats">
            <span id="currentConversation">0</span> of <span id="totalConversations">0</span> conversations
        </div>
    </div>

    <div class="conversation-container">
        <div id="conversationDisplay">
            <!-- Conversations will be loaded here -->
        </div>
        
        <div class="export-section">
            <h3>Export Labeled Data</h3>
            <p>Click the button below to download all labeled conversations as a JSON file.</p>
            <button class="export-button" onclick="exportLabeledData()">Export Labeled Conversations</button>
        </div>
    </div>

    <div class="navigation">
        <button class="nav-button secondary" onclick="previousConversation()">← Previous</button>
        <button class="nav-button primary" onclick="nextConversation()">Next →</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        let conversations = [];
        let currentIndex = 0;
        let labels = {};

        function extractMessages(conversation) {
            const messages = [];
            
            if (!conversation.mapping) {
                return messages;
            }
            
            // Get all nodes and sort them by creation time
            const allNodes = Object.values(conversation.mapping).filter(node => 
                node.message && 
                node.message.content && 
                node.message.content.content_type === 'text' &&
                node.message.content.parts?.[0]?.trim() !== ''
            );
            
            // Sort by creation time to get chronological order
            allNodes.sort((a, b) => {
                const timeA = a.message.create_time || 0;
                const timeB = b.message.create_time || 0;
                return timeA - timeB;
            });
            
            allNodes.forEach(node => {
                const role = node.message.author?.role || 'user';
                const content = node.message.content.parts?.[0] || '';
                
                if (content && content.trim() !== '') {
                    messages.push({
                        role: role,
                        content: content.trim()
                    });
                }
            });
            
            console.log('Extracted messages:', messages);
            return messages;
        }

        async function loadConversations() {
            try {
                // Try to find the most recent selected conversations file
                const response = await fetch('selected_conversations.json');
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Loaded data:', data);
                console.log('Data structure:', Object.keys(data));
                
                conversations = data.conversations || data;
                console.log('Conversations loaded:', conversations.length);
                
                currentIndex = 0;
                updateStats();
                displayCurrentConversation();
            } catch (error) {
                console.error('Error loading conversations:', error);
                document.getElementById('conversationDisplay').innerHTML = 
                    '<p style="color: red;">Error loading conversations: ' + error.message + '</p>';
            }
        }

        function updateStats() {
            document.getElementById('currentConversation').textContent = currentIndex + 1;
            document.getElementById('totalConversations').textContent = conversations.length;
        }

        function displayCurrentConversation() {
            if (conversations.length === 0) {
                document.getElementById('conversationDisplay').innerHTML = 
                    '<p>No conversations to display.</p>';
                return;
            }

            const conversation = conversations[currentIndex];
            console.log('Current conversation:', conversation);
            
            // Extract messages from the complex structure
            const messages = extractMessages(conversation);
            console.log('Messages to display:', messages);
            
            let html = `
                <div class="conversation">
                    <div class="conversation-header">
                        <div class="conversation-title">${escapeHtml(conversation.title || 'Untitled Conversation')}</div>
                        <div class="ai-classification">
                            AI Classification: ${conversation.aiCategory || 'Not classified'} - ${conversation.aiExplanation || ''}
                        </div>
                    </div>
                    <div class="messages">
            `;

            messages.forEach((message, messageIndex) => {
                const role = message.role;
                const content = message.content;
                
                // Skip system messages and empty messages
                if (role === 'system' || !content || content.trim() === '') {
                    return;
                }
                
                // Convert markdown to HTML
                const htmlContent = marked.parse(content);
                
                // Get message labels
                const messageLabels = labels[currentIndex]?.[messageIndex] || {};
                
                html += `
                    <div class="message ${role}">
                        <div class="avatar ${role}">${role === 'user' ? 'U' : 'A'}</div>
                        <div class="message-content">${htmlContent}</div>
                        <div class="message-labels">
                            <div class="label-inputs">
                                <div class="label-input">
                                    <label>Notes:</label>
                                    <textarea 
                                           placeholder="Additional notes..." 
                                           onchange="updateMessageLabel(${currentIndex}, ${messageIndex}, 'notes', this.value)" 
                                           style="width: 100%; min-height: 60px; padding: 6px; border: 1px solid #d1d5db; border-radius: 3px; font-size: 11px; resize: vertical;">${messageLabels.notes || ''}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            document.getElementById('conversationDisplay').innerHTML = html;
        }

        function updateLabel(index, field, value) {
            if (!labels[index]) {
                labels[index] = {};
            }
            labels[index][field] = value;
        }

        function updateMessageLabel(conversationIndex, messageIndex, field, value) {
            if (!labels[conversationIndex]) {
                labels[conversationIndex] = {};
            }
            if (!labels[conversationIndex][messageIndex]) {
                labels[conversationIndex][messageIndex] = {};
            }
            labels[conversationIndex][messageIndex][field] = value;
        }

        function nextConversation() {
            if (currentIndex < conversations.length - 1) {
                currentIndex++;
                updateStats();
                displayCurrentConversation();
            }
        }

        function previousConversation() {
            if (currentIndex > 0) {
                currentIndex--;
                updateStats();
                displayCurrentConversation();
            }
        }

        function exportLabeledData() {
            const labeledConversations = conversations.map((conv, index) => ({
                ...conv,
                labels: labels[index] || {}
            }));

            const exportData = {
                exportDate: new Date().toISOString(),
                totalConversations: conversations.length,
                labeledConversations: labeledConversations,
                labels: labels
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `labeled_conversations_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert(`Exported ${conversations.length} conversations with labels!`);
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowRight') {
                e.preventDefault();
                nextConversation();
            } else if (e.key === 'ArrowLeft') {
                e.preventDefault();
                previousConversation();
            }
        });

        // Load conversations when the page loads
        loadConversations();
    </script>
</body>
</html> 